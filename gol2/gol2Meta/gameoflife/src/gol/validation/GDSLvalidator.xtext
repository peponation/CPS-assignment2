package gol.validation

import org.eclipse.xtext.validation.Check
import gol.gDSL.Rule
import gol.gDSL.GDSLPackage
import gol.gDSL.Grid
import gol.gDSL.Rules
import java.util.HashSet

class GDSLValidator extends AbstractGDSLValidator {

	// RULE 1: Neighbor count should never exceed 8
	@Check
	def checkNeighborAmount(Rule rule) {
	    if (rule.amount > 8) {
	        error("A cell cannot have more than 8 neighbors.", 
	            GDSLPackage.Literals.RULE__AMOUNT)
	    }
	}
	
	// RULE 2: Warn when the same cell is defined twice
	@Check
	def checkDuplicateCells(Grid grid) {
	    val seenCoordinates = new HashSet<String>()
	    
	    for (i : 0 ..< grid.cell.size) {
	        val cell = grid.cell.get(i)
	        val key = cell.x + "," + cell.y
	        
	        if (seenCoordinates.contains(key)) {
	            warning("Duplicate cell.", 
	                GDSLPackage.Literals.GRID__CELL, 
	                i
	            )
	        } else {
	            seenCoordinates.add(key)
	        }
	    }
	}
	
	// RULE 3: Detect rules with the same condition but different outcomes
	@Check
	def checkRuleConflicts(Rules rules) {
	    for (i : 0 ..< rules.rules.size) {
	        val ruleA = rules.rules.get(i)
	        
	        for (j : i + 1 ..< rules.rules.size) {
	            val ruleB = rules.rules.get(j)
	            
	            if (ruleA.operator == ruleB.operator && ruleA.amount == ruleB.amount &&
	                ruleA.state != ruleB.state) {
	                
	                error("Conflicting rules for the same condition.",
	                    GDSLPackage.Literals.RULES__RULES,
	                    j
	                )
	            }
	        }
	    }
	}

}
